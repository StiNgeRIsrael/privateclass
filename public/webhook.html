<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Handler</title>
    <script type="module">
        // ××¢×¨×›×ª API ×œ×—×™×‘×•×¨ ×œ-MySQL
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3001/api' 
            : 'https://stingerisrael.co.il/class/api';

        // ×¤×•× ×§×¦×™×” ×œ×©×œ×™×—×ª ×‘×§×©×•×ª API
        async function apiRequest(endpoint, options = {}) {
            try {
                const url = `${API_BASE_URL}${endpoint}`;
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers,
                    },
                    ...options,
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                throw error;
            }
        }

        // ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×ª×©×œ×•×
        async function updatePaymentStatus(paymentId, status, transactionId = null) {
            try {
                return await apiRequest(`/payments/${paymentId}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status, transactionId }),
                });
            } catch (error) {
                console.error('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×ª×©×œ×•×:', error);
                return { success: false, error: error.message };
            }
        }

        // ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª ×¤×¨×˜×™ ×œ×§×•×—
        async function getCustomerDetails(customerId) {
            try {
                return await apiRequest(`/customers/${customerId}`);
            } catch (error) {
                console.error('×©×’×™××” ×‘×§×‘×œ×ª ×¤×¨×˜×™ ×œ×§×•×—:', error);
                return null;
            }
        }

        // ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª ×¤×¨×˜×™ ×ª×©×œ×•×
        async function getPaymentDetails(paymentId) {
            try {
                return await apiRequest(`/payments/${paymentId}`);
            } catch (error) {
                console.error('×©×’×™××” ×‘×§×‘×œ×ª ×¤×¨×˜×™ ×ª×©×œ×•×:', error);
                return null;
            }
        }

        // Discord Webhook URL
        const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1404519345853431962/Z-Q7si_GHrkz5B70UD_0mZ6HfuydH3XHFUB0UyYh0xoxv2Vv5vNq7lQ2VEEAgcGiC6Ke';

        // ×¤×•× ×§×¦×™×” ×œ×©×œ×™×—×ª ×”×•×“×¢×” ×œ×“×™×¡×§×•×¨×“
        async function sendDiscordNotification(paymentData, customerData) {
            try {
                const embed = {
                    title: 'ğŸ‰ ×ª×©×œ×•× ×—×“×© ×”×ª×§×‘×œ!',
                    color: 0x00ff00,
                    fields: [
                        {
                            name: 'ğŸ‘¤ ×¤×¨×˜×™ ×œ×§×•×—',
                            value: `**×©× ×”×•×¨×”:** ${customerData.parent_name}\n**×©× ×™×œ×“:** ${customerData.child_name}\n**×˜×œ×¤×•×Ÿ:** ${customerData.parent_phone}\n**××™××™×™×œ:** ${customerData.parent_email}`,
                            inline: true
                        },
                        {
                            name: 'ğŸ’° ×¤×¨×˜×™ ×ª×©×œ×•×',
                            value: `**×—×‘×™×œ×”:** ${paymentData.plan_name}\n**×¡×›×•×:** ${paymentData.plan_amount} â‚ª\n**×¡×˜×˜×•×¡:** ${paymentData.status}\n**××–×”×” ×¢×¡×§×”:** ${paymentData.transaction_id || '×œ× ×–××™×Ÿ'}`,
                            inline: true
                        },
                        {
                            name: 'ğŸ“… ×¤×¨×˜×™× × ×•×¡×¤×™×',
                            value: `**×’×™×œ ×™×œ×“:** ${customerData.child_age}\n**×¨××”:** ${customerData.level}\n**×ª××¨×™×š:** ${new Date(paymentData.created_at).toLocaleDateString('he-IL')}`,
                            inline: false
                        }
                    ],
                    timestamp: new Date().toISOString(),
                    footer: {
                        text: 'Stinger Class - ××¢×¨×›×ª ××•×˜×•××˜×™×ª'
                    }
                };

                const payload = {
                    content: `<@145679462585991169> ×™×© ×œ×š ×ª×©×œ×•× ×—×“×©!`,
                    embeds: [embed]
                };

                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    console.log('âœ… ×”×•×“×¢×” × ×©×œ×—×” ×œ×“×™×¡×§×•×¨×“ ×‘×”×¦×œ×—×”');
                } else {
                    console.error('âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×” ×œ×“×™×¡×§×•×¨×“');
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×” ×œ×“×™×¡×§×•×¨×“:', error);
            }
        }

        // ×¤×•× ×§×¦×™×” ×œ×©×œ×™×—×ª ×”×•×“×¢×” ×œ×•×•××˜×¡××¤
        function sendWhatsAppNotification(customerData) {
            try {
                const message = `×©×œ×•×! ×™×© ×œ×š ×œ×§×•×— ×—×“×© ×©× ×¨×©× ×œ×©×™×¢×•×¨:

ğŸ‘¤ **×¤×¨×˜×™ ×”×œ×§×•×—:**
×©× ×”×•×¨×”: ${customerData.parent_name}
×©× ×™×œ×“: ${customerData.child_name}
×˜×œ×¤×•×Ÿ: ${customerData.parent_phone}
××™××™×™×œ: ${customerData.parent_email}

ğŸ“š **×¤×¨×˜×™ ×”×©×™×¢×•×¨:**
×’×™×œ ×™×œ×“: ${customerData.child_age}
×¨××”: ${customerData.level}

×× × ×¦×•×¨ ×§×©×¨ ×¢× ×”×”×•×¨×” ×œ×ª×™××•× ×”×©×™×¢×•×¨ ×”×¨××©×•×Ÿ.

×ª×•×“×”! ğŸ®`;

                // ×™×¦×™×¨×ª ×§×™×©×•×¨ ×•×•××˜×¡××¤
                const whatsappUrl = `https://wa.me/972${customerData.parent_phone.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
                
                console.log('ğŸ“± ×§×™×©×•×¨ ×•×•××˜×¡××¤:', whatsappUrl);
                
                // ××¤×©×¨×•×ª ×œ×¤×ª×™×—×ª ×—×œ×•×Ÿ ×•×•××˜×¡××¤
                // window.open(whatsappUrl, '_blank');
            } catch (error) {
                console.error('×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×” ×œ×•×•××˜×¡××¤:', error);
            }
        }

        // ×”××–× ×” ×œ×”×•×“×¢×•×ª
        window.addEventListener('message', async (event) => {
            try {
                const { type, data } = event.data;
                
                if (type === 'IPN_UPDATE') {
                    const { paymentId, status, transactionId } = data;
                    
                    console.log('ğŸ”„ ×¢×“×›×•×Ÿ IPN ×”×ª×§×‘×œ:', { paymentId, status, transactionId });
                    
                    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×”×ª×©×œ×•×
                    const result = await updatePaymentStatus(paymentId, status, transactionId);
                    
                    if (result.success && status === 'paid') {
                        // ×§×‘×œ×ª ×¤×¨×˜×™ ×”×ª×©×œ×•×
                        const paymentData = await getPaymentDetails(paymentId);
                        
                        if (paymentData) {
                            // ×§×‘×œ×ª ×¤×¨×˜×™ ×”×œ×§×•×—
                            const customerData = await getCustomerDetails(paymentData.customer_id);
                            
                            if (customerData) {
                                // ×©×œ×™×—×ª ×”×•×“×¢×” ×œ×“×™×¡×§×•×¨×“
                                await sendDiscordNotification(paymentData, customerData);
                                
                                // ×©×œ×™×—×ª ×”×•×“×¢×” ×œ×•×•××˜×¡××¤
                                sendWhatsAppNotification(customerData);
                                
                                console.log('âœ… ×›×œ ×”×”×•×“×¢×•×ª × ×©×œ×—×• ×‘×”×¦×œ×—×”');
                            }
                        }
                    }
                    
                    // ×©×œ×™×—×ª ××™×©×•×¨ ×—×–×¨×”
                    event.source.postMessage({
                        type: 'IPN_RESPONSE',
                        success: result.success,
                        paymentId,
                        status
                    }, event.origin);
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×¢×™×‘×•×“ IPN:', error);
                
                // ×©×œ×™×—×ª ×©×’×™××” ×—×–×¨×”
                if (event.source) {
                    event.source.postMessage({
                        type: 'IPN_ERROR',
                        error: error.message
                    }, event.origin);
                }
            }
        });

        console.log('Webhook handler loaded and ready (API version)');
    </script>
</head>
<body>
    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
        <h1>ğŸ”„ Webhook Handler</h1>
        <p>××¢×¨×›×ª ×¢×™×‘×•×“ ×ª×©×œ×•××™× ×¤×•×¢×œ×ª...</p>
        <div id="status">×××ª×™×Ÿ ×œ×¢×“×›×•× ×™×...</div>
    </div>
</body>
</html>
